
# 未完成

我们接着《类组件初始化阶段-生命周期钩子函数调用》，在进行完 `RootFiber` 的任务后，就会创建一个 虚拟DOM的type为A的 子节点fiber,并且这时，这个fiber的tag为1。
这在`beginWork`中会进入 `ClassComponent`分支，然后执行 `updateClassComponent()`，首先会执行`constructClassInstance()`,初始化constructor。

在这个函数中，会执行一个`adoptClassInstance()`，它的作用就是会给每个类组件初始化一个updater，这个`updater.enqueueSetState`就是调用setState时触发的函数。并且会在类组件的每个实例都有设置一个 `_reactInternalFiber` 属性，值为 `workInProgress` 

```js
// 在初始化时，当遇到的Fiber 的tag是一个类组件时，会给实例增加一个updater，这个updater就是调用setState时触发的函数
function adoptClassInstance(workInProgress: Fiber, instance: any): void {
  instance.updater = classComponentUpdater;
  workInProgress.stateNode = instance;
  // The instance needs access to the fiber so that it can schedule updates
  // 类组件的每个实例都有一个 _reactInternalFiber 和 workInProgress 挂钩
  setInstance(instance, workInProgress);
}

const classComponentUpdater = {
  isMounted,
  enqueueSetState(inst, payload, callback) {
    // 获取到当前实例对应的fiber任务
    const fiber = getInstance(inst);

    // 接下来和updateContainer的逻辑一样
    const currentTime = requestCurrentTimeForUpdate();
    const suspenseConfig = requestCurrentSuspenseConfig();
    const expirationTime = computeExpirationForFiber(
      currentTime,
      fiber,
      suspenseConfig,
    );

    const update = createUpdate(expirationTime, suspenseConfig);
    update.payload = payload;
    if (callback !== undefined && callback !== null) {

      update.callback = callback;
    }

    enqueueUpdate(fiber, update);
    scheduleWork(fiber, expirationTime);
  },
  enqueueReplaceState,
  enqueueForceUpdate
}
```